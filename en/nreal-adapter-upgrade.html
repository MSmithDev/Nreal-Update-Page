<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
  <head>
    <title>Nreal Adapter - firmware update</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" sizes="57x57" href="../favori/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../favori/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../favori/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../favori/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../favori/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../favori/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../favori/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../favori/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../favori/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../favori/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favori/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../favori/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favori/favicon-16x16.png">
    <link rel="manifest" href="../favori/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <!-- <meta http-equiv="refresh" content="0;url=https://www.nreal.ai/support/activationGlasses"> -->
    <style>
      body {
        font-family: 'Poppins', 'SF Pro JP', Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
      }

      /* * {

            box-sizing: border-box;
        } */

      .btnStandard {
        width: auto;
        min-width: 160px;
        height: 40px;
        border-radius: 20px;
        border: 3px solid black;
        background-color: black;
        color: white;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: 0.2s;
      }

      .btnStandard[disabled] {
        color: white !important;
        background: #ccc !important;
        cursor: not-allowed;
        border: 3px solid #ccc;
      }

      .btnStandard:hover {
        background-color: white;
        color: black;
      }

      .tipStyle {
        border: 3px solid black;
        padding: 20px;
        margin: 20px auto;
        /* max-width: 360px; */
        /* max-width: 480px; */
        width: calc(100% - 40px);
      }

      .guideStyle {
        padding: 20px;
        margin: 20px auto;
        text-align: center;
        align-items: center;
      }

      .alertStyle {
        background-color: rgb(255, 231, 74);
        padding: 20px;
        margin: 20px auto;
        max-width: 300px;
        height: auto;
        font-weight: normal;
      }

      .failStyle {
        background-color: rgb(255, 231, 74);
        color: black;
        font-weight: bold;
        margin: 10px auto;
        width: auto;
        min-width: 200px;
        padding-top: 5px;
        padding-bottom: 5px;
      }

      .areaStyle {
        width: 260px;
        height: 30px;
        user-select: none;
        margin: 10px auto;
        border: none;
        overflow: auto;
        outline: none;
        box-shadow: none;
        resize: none;
        background-color: rgba(0, 0, 0, 0);
        text-align: center;
      }

      h1 {
        font-size: 34px;
        font-weight: bold;
      }

      h2 {
        font-size: 26px;
      }

      .line {
        width: 100%;
        height: 2px;
        border-bottom: 1px solid rgb(209, 209, 209);
      }

      .spaceM {
        width: 100%;
        height: 30px;
      }

      .spaceL {
        width: 100%;
        height: 80px;
      }

      .spaceXL {
        width: 100%;
        height: 100px;
      }

      .r3 {
        border-radius: 3px;
      }

      .r6 {
        border-radius: 6px;
      }

      .r20 {
        border-radius: 20px;
      }

      .r25 {
        border-radius: 25px;
      }

      .r30 {
        border-radius: 30px;
      }

      .shdwS {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .shdwS:hover {
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
      }

      .progressNumber {
        font-size: 36px;
        font-weight: 700;
        padding: 12px 0;
      }

      @media screen and (max-width: 768px) {
        .video {
          width: 280px;
          height: 150px;
        }
      }

      .topImage {
        padding: 36px;
      }

      .warning {
        color: red;
      }

      .content {
        width: calc(100% - 20px);
        height: auto;
        padding: 40px 10px 160px;
        /* box-sizing: border-box; */
      }

      .flex_column {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .flex_row {
        display: flex;
        justify-content: center;
      }

      .text_emphasize {
        font-weight: bold;
        font-size: 18px;
      }

      p {
        font-size: 15px;
      }

      .alink {
        text-decoration: none;
      }

      .font30 {
        font-size: 30px;
      }

      .font15 {
        font-size: 15px;
      }

      .bold {
        font-weight: bold;
      }

      .panel {
        text-align: center;
        background-color: rgb(241, 245, 247);
        padding: 30px;

        width: calc(100% - 60px);
        max-width: 650px;
      }

      .box {
        text-align: center;
        background-color: rgb(241, 245, 247);
        padding: 30px;
        width: calc(100% - 60px);
        max-width: 640px;
      }

      .bg_brightyellow {
        background-color: rgb(255, 235, 103);
      }

      .space16 {
        height: 16px;
        width: 100%;
      }

      .okStyle {
        background-color: rgb(0, 245, 0);
        color: black;
        font-weight: bold;
        margin: 10px auto;
        /* width: auto; */
        width: 100%;
        padding-top: 5px;
        padding-bottom: 5px;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="../css/Poppins.css">
  </head>
  <!-- Google tag (gtag.js) -->
  <script async="" src="../gtag/js?id=G-93DMZBDWJK"></script>
  <script>
    window.dataLayer = window.dataLayer || []
    function gtag() {
      dataLayer.push(arguments)
    }
    gtag('js', new Date())
    gtag('config', 'G-93DMZBDWJK')
  </script>

  <body>
    <div class="content flex_column">
      <img src="../images/logo_Nreal.png" width="150px">
      <br><br>
      <h1>Instructions</h1>
      <div class="panel r20 flex_column">
        <img src="../images/adapter.png" alt="Nreal Air" width="128px" height="105px" style="margin: 16px 0 36px">
        <span class="font15">This page is used for firmware update for
          <span class="text_emphasize"> Nreal Adapter </span>
          .<br><br>
          Please follow the step-by-step instructions.<br><br>
          If you experience any issues during the update, try disconnecting the adapter and refreshing the page to start over.<br><br>
          If you need more support, you can communicate with customer service in the lower right corner of the official website homepage, or go to the user
          community for more information: <a class="alink" href="https://www.reddit.com/r/nreal" target="_blank"> https://www.reddit.com/r/nreal </a>.
        </span>
      </div>
      <div class="spaceL"></div>
      <h1>Notes</h1>
      <div class="panel r20 bg_brightyellow flex_column">
        <span class="font30 warning" id="noSupportHid" style="display: none">There seems to be a compatibility issue with your browser.</span>
        <span class="font30">
          Please make sure your browser is<span style="font-weight: bold"> Google Chrome (version 89 or later)</span> or
          <span style="font-weight: bold">Edge (version 89 or later).</span>
          <br>
          <span class="warning">Please don't use a Type-C to Type-C cable to connect.</span>
        </span>
      </div>
      <div class="box r20 flex_column" style="margin: 16px 0px">
        <img src="../images/adapter-2typec.svg" alt="adapter-2typec" style="margin-bottom: 16px; max-width: 100%">
        <img src="../images/adapter-usb.svg" alt="adapter-usb" style="margin-bottom: 16px; max-width: 100%">
        <img src="../images/adapter-dock.svg" alt="adapter-dock" style="max-width: 100%">
      </div>
      <div class="panel r20 bg_brightyellow flex_column">
        <span class="font30">
          Please make sure that only one pair of Nreal glasses are connected to your laptop during the update. Do not connect multiple glasses, or Nreal glasses
          and Nreal Adapter at the same time.
        </span>
      </div>
      <h1>Start</h1>
      <div class="box r20 flex_column">
        <h2>1. Connect the Nreal Adapter to your laptop using a USB-C cable and click on "Connect"</h2>
        <span class="font15">For all pop-up windows, please select Nreal Adapter or NREAL Ada from the device list and click on "Connect". </span>
        <div class="space16"></div>
        <button id="connect" class="btnStandard en_ada_connect">Connect</button>
        <span class="okStyle" style="display: none" id="hadConnect">Connected</span>
        <span id="firmware"></span>
        <div id="noneedupdate" style="display: none" class="okStyle">Your firmware is the latest. There's no update available.</div>
        <div class="spaceM"></div>
      </div>
      <div class="spaceM"></div>
      <div class="box r20">
        <h2>2. Update the firmware</h2>
        <p>For all pop-up windows, please select NREAL Ada from the device list and click on "Connect".</p>
        <span class="warning">During the update, please don't leave the current page or disconnect your device.</span><br><br>
        <button id="upgrade" class="btnStandard en_ada_firmware_update" style="width: 200px">Update the firmware</button>
        <div id="progress" class="progressNumber" style="display: none">0%</div>
        <div id="success" class="okStyle" style="display: none">Firmware update successful</div>

        <div id="fail" class="failStyle" style="display: none">Error. Please refresh the pate and try again.</div>
        <div class="tipStyle">
          Once your Nreal Adapter is updated, please proceed to update your<a class="alink" href="nreal-air-upgrade-plus.html" target="_blank">
            Nreal Air </a>. Please ignore this message if your Nreal Air is already updated.
        </div>
        <div class="spaceM"></div>
      </div>
    </div>
    <div class="spaceXL"></div>
    <div class="spaceXL"></div>
    <div class="spaceXL"></div>
    <script type="module">
      import * as adaSDK from '../js_ada/manager.js'
      import * as GA from '../addGa.js'
      import http from '../tools/http.js'
      import downloadfiles from '../tools/downloadfile.js'
      import http_blob from '../tools/http_blob.js'
      let fileUrl = null
      // 点击连接设备按钮
      function connect() {
        adaSDK
          .connectDevice()
          .then(async (devices) => {
            // console.log(devices, "check connect")
            if (devices) {
              let version = await firmwareVersion()
              document.getElementById('hadConnect').style.display = 'block'
              document.getElementById('connect').style.opacity = '0'
              document.getElementById('firmware').innerHTML = 'The firmware version of the device is: ' + version

              // version 形式11.1.07.001_20220807，firmwareVersion返回有特殊字符NUL，固做长度截断处理
              let versionp = version.substring(0, 20)
              http.get(
                { url: `/nebula/v1/isc/admin/device/version/check?deviceType=3&country=2&fileType=20&currentFileName=adapter_${versionp}.bin`, timeout: 2000 },
                async function (err, result) {
                  if (err) {
                    alert('Error. Please refresh and try again. ')
                  } else {
                    let islatest = result.data.isLatest
                    if (islatest) {
                      fileUrl = null
                      document.getElementById('noneedupdate').innerText = 'Your device has the latest firmware. No update available.'
                      document.getElementById('noneedupdate').style.display = 'block'
                      GA.addGa('ada_noupdate_require', {
                        lang: 'en',
                      })
                    } else {
                      fileUrl = result.data.uri
                      document.getElementById('upgrade').disabled = false
                      GA.addGa('ada_update_require', {
                        lang: 'en',
                      })
                    }
                  }
                }
              )
              let box2_sn = await adaSDK.getSN()
              let box2_version = version
              let box2_sn_duration = []
              let a1 = await adaSDK.getConnectGlasses1()
              a1 ? box2_sn_duration.push(a1) : null
              let a2 = await adaSDK.getConnectGlasses2()
              a2 ? box2_sn_duration.push(a2) : null
              let a3 = await adaSDK.getConnectGlasses3()
              a3 ? box2_sn_duration.push(a3) : null
              let a4 = await adaSDK.getConnectGlasses4()
              a4 ? box2_sn_duration.push(a4) : null
              let a5 = await adaSDK.getConnectGlasses5()
              a5 ? box2_sn_duration.push(a5) : null

              GA.addGa('ada_connect_success', {
                lang: 'en',
              })
              // console.log(box2_sn, box2_version, a1, a2, a3, a4, a5, "333")
              GA.addGa('ada_info', {
                lang: 'en',
                box2_sn: box2_sn,
                box2_version: box2_version,
                box2_sn_duration: box2_sn_duration,
              })
            } else {
              alert('The device is not detected. Please connect it.')
            }
          })
          .catch((err) => {
            GA.addGa('ada_connect_fail', {
              lang: 'en',
              errinfo: err ? err : 'no device',
            })
            alert('Error. Please refresh and try again.')
          })
      }
      // 获取设备版本
      function firmwareVersion() {
        return adaSDK
          .getFirmwareVersion()
          .then((version) => {
            return version
          })
          .catch((err) => {
            alert('Failed to get the device version, please refresh and try again.')
            return
          })
      }

      // 升级文件
      async function upgrade() {
        const url = fileUrl
        http_blob.get({ url: url, timeout: 2000 }, async function (err, res) {
          if (err) {
            alert('Failed to get the binary file, please refresh and try again.')
            return
          } else {
            let binFile = await res
            let version = await firmwareVersion()
            if (version == null || version == 'not found device') {
              alert('The device is not connected. Please connect it.')
              return
            }
            let data = await binFile.arrayBuffer()
            document.getElementById('upgrade').style.display = 'none'
            document.getElementById('progress').style.display = 'block'
            let result = await adaSDK.upgrade(data)
            // console.log('data', result);
            if (result) {
              document.getElementById('success').style.display = 'block'
              GA.addGa('ada_firmware_update_complete', {
                lang: 'en',
                filename: binFile.name,
              })
            } else {
              document.getElementById('fail').style.display = 'block'
              let percent = document.getElementById('progress').innerHTML
              document.getElementById('progress').style.display = 'none'
              GA.addGa('ada_firmware_update_fail', {
                lang: 'en',
                filename: binFile.name,
                percent: percent,
              })
            }
          }
        })
      }

      window.onload = async () => {
        if (!adaSDK?.hidSupported()) {
          document.getElementById('noSupportHid').style.display = 'block'
          GA.addGa('ada_browser_wrong', {
            lang: 'en',
          })
          return
        }
        GA.addGa('ada_browser_correct', {
          lang: 'en',
        })
        // 按钮事件绑定
        // 连接设备
        document.getElementById('connect').onclick = connect
        // 升级ada
        document.getElementById('upgrade').onclick = upgrade

        // 初始页面，未连接设备状态
        document.getElementById('upgrade').disabled = true
      }
    </script>
    <script src="../point.js"></script>
  </body>
</html>
